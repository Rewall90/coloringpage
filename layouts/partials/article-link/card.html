{{ $disableImageOptimization := .Page.Site.Params.disableImageOptimization | default false }}
<div
  class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700">
  <a
    {{ partial "article-link/_external-link.html" . | safeHTMLAttr }}
    class="absolute inset-0"
    aria-label="{{ $.Title }}"></a>
  
  {{/* Hero Image Section - Using proper <img> tags for SEO */}}
  {{ $featuredImage := .Params.featureimage }}
  {{ $imageAlt := .Params.image_alt | default .Title }}
  {{ $imageWidth := .Params.image_width | default 750 }}
  {{ $imageHeight := .Params.image_height | default 1000 }}
  {{ $imageSrcset := .Params.image_srcset }}
  
  {{ if or $featuredImage .Params.image_width }}
    {{/* Category pages and collection posts with hierarchical image URLs */}}
    <figure class="w-full overflow-hidden aspect-[3/4]">
      {{ if .Params.image_width }}
        {{/* Real-time transformation URLs for collections and categories */}}
        {{ $baseUrl := "" }}
        {{ if eq .Type "coloring-category" }}
          {{ $baseUrl = printf "/main-category/%s/%s-category.webp" .Section .Section }}
        {{ else }}
          {{ $baseUrl = printf "/collections/%s/%s.webp" .Section (path.BaseName .RelPermalink) }}
        {{ end }}
        <noscript>
          <img decoding="async" 
               src="{{ $baseUrl }}?w=300&h=400&q=75&fit=cover&format=auto" 
               alt="{{ $imageAlt }}"
               sizes="(max-width: 300px) 100vw, 300px">
        </noscript>
        <img decoding="async" 
             width="300" 
             height="400"
             src="{{ $baseUrl }}?w=300&h=400&q=75&fit=cover&format=auto" 
             alt="{{ $imageAlt }}"
             class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
             data-pin-url="{{ absURL .RelPermalink }}"
             data-pin-title="{{ .Title }} | {{ site.Title }}"
             data-pin-description="{{ .Summary | default "Free, premium printable coloring pages for kids. Easy access and zero cost for endless fun and creativity!" }}"
             srcset="{{ $baseUrl }}?w=200&h=267&q=75&fit=cover&format=auto 200w, 
                     {{ $baseUrl }}?w=300&h=400&q=75&fit=cover&format=auto 300w, 
                     {{ $baseUrl }}?w=768&h=1024&q=75&fit=cover&format=auto 768w, 
                     {{ $baseUrl }}?w=896&h=1195&q=75&fit=cover&format=auto 896w"
             sizes="(max-width: 300px) 100vw, 300px"
             loading="lazy">
      {{ else if $featuredImage }}
        {{/* Fallback to existing image logic */}}
        <img 
          decoding="async"
          loading="lazy"
          src="{{ $featuredImage }}"
          alt="{{ $imageAlt }}"
          width="{{ $imageWidth }}"
          height="{{ $imageHeight }}"
          class="w-full h-full object-contain"
          {{ if $imageSrcset }}
          srcset="{{ $imageSrcset }}"
          sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 600px"
          {{ end }}
        />
      {{ end }}
    </figure>
  {{ else }}
    {{/* Fallback for posts without hierarchical URLs */}}
    {{ $heroImage := .Params.image }}
    {{ if $heroImage }}
      <figure class="w-full overflow-hidden aspect-[3/4]">
        <img 
          decoding="async"
          loading="lazy"
          src="{{ $heroImage }}"
          alt="{{ $imageAlt }}"
          class="w-full h-full object-contain"
        />
      </figure>
    {{ else }}
      {{/* Hugo resource-based images (posts) */}}
      {{- $images := $.Resources.ByType "image" -}}
      {{- $featured := $images.GetMatch "*feature*" -}}
      {{- if not $featured }}{{ $featured = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end -}}
      {{ if and .Params.featureimage (not $featured) }}
        {{- $url:= .Params.featureimage -}}
        {{ $featured = resources.GetRemote $url }}
      {{ end }}
      {{- if not $featured }}
        {{ with .Site.Params.defaultFeaturedImage }}{{ $featured = resources.Get . }}{{ end }}
      {{ end -}}
      {{ if .Params.hideFeatureImage }}{{ $featured = false }}{{ end }}
      {{- with $featured -}}
        <figure class="w-full overflow-hidden aspect-[3/4]">
          {{ if or $disableImageOptimization (strings.HasSuffix $featured ".svg") }}
            <img 
              decoding="async"
              loading="lazy"
              src="{{ .RelPermalink }}"
              alt="{{ $imageAlt }}"
              class="w-full h-full object-contain"
            />
          {{ else }}
            {{ with .Resize "600x" }}
              <img 
                decoding="async"
                loading="lazy"
                src="{{ .RelPermalink }}"
                alt="{{ $imageAlt }}"
                class="w-full h-full object-contain"
              />
            {{ end }}
          {{ end }}
        </figure>
      {{- else -}}
        {{/* No image available - show placeholder */}}
        <div class="w-full aspect-[3/4] bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center">
          <span class="text-white text-lg font-medium">{{ .Title }}</span>
        </div>
      {{- end -}}
    {{ end }}
  {{ end }}
  
  {{/* Draft Badge */}}
  {{ if and .Draft .Site.Params.article.showDraftLabel }}
    <span class="absolute top-0 right-0 m-2">
      {{ partial "badge.html" (i18n "article.draft" | emojify) }}
    </span>
  {{ end }}
  
  {{/* Content Section */}}
  <div class="px-6 py-4">
    {{ with .Params.externalUrl }}
      <h3
        class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">
        {{ $.Title | emojify }}
        <span class="cursor-default align-top text-xs text-neutral-400 dark:text-neutral-500">
          <span class="rtl:hidden">&#8599;</span>
          <span class="ltr:hidden">&#8598;</span>
        </span>
      </h3>
    {{ else }}
      <h3
        class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">
        {{ .Title | emojify }}
      </h3>
    {{ end }}
  </div>
</div>