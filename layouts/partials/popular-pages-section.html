{{/* Popular Pages Section - Reusable partial for displaying popular coloring pages */}}
{{ $enabled := .Site.Params.homepage.popularPages.enabled | default false }}
{{ if $enabled }}
  {{ $title := .Site.Params.homepage.popularPages.title | default "Popular Coloring Pages" }}
  {{ $limit := .Site.Params.homepage.popularPages.limit | default 8 }}
  {{ $fallbackToRecent := .Site.Params.homepage.popularPages.fallbackToRecent | default true }}
  
  {{/* Get all pages from coloring page sections (excluding system sections) */}}
  {{ $coloringPages := slice }}
  {{ $excludeSections := slice "posts" "pages" "coloring-pages" }}
  {{ range .Site.RegularPages }}
    {{ if and (strings.HasSuffix .Section "-coloring-pages") (not (in $excludeSections .Section)) }}
      {{ $coloringPages = $coloringPages | append . }}
    {{ end }}
  {{ end }}

  {{/* Filter pages that are marked as featured/popular */}}
  {{ $featuredPages := slice }}
  {{ range $coloringPages }}
    {{ if .Params.featured }}
      {{ $featuredPages = $featuredPages | append . }}
    {{ end }}
  {{ end }}

  {{/* If we have featured pages, use them. Otherwise fallback to recent if enabled */}}
  {{ $finalPages := slice }}
  {{ if gt (len $featuredPages) 0 }}
    {{ $finalPages = ($featuredPages | first $limit) }}
  {{ else if $fallbackToRecent }}
    {{ $finalPages = ($coloringPages.ByDate.Reverse | first $limit) }}
  {{ end }}
  
  {{ if $finalPages }}
    <section class="popular-pages-section py-16" aria-labelledby="popular-pages-heading">
      <div class="max-w-7xl mx-auto px-6">
        <h2 id="popular-pages-heading" class="text-3xl md:text-4xl font-bold text-neutral-900 dark:text-neutral mb-8 text-left">
          {{ $title }}
        </h2>
        
        <div class="popular-pages-grid" aria-label="{{ $title }}">
          {{ range $finalPages }}
            <div>
              {{ partialCached "popular-page-card.html" . .RelPermalink }}
            </div>
          {{ end }}
        </div>
      </div>
    </section>
  {{ end }}
{{ end }}