{{/* Logo section */}}
{{ define "HeaderLogo" }}
  {{ if .Site.Params.Logo }}
    {{ $logo := resources.Get .Site.Params.Logo }}
    {{ if $logo }}
      <div>
        <a href="{{ "" | relLangURL }}" class="flex">
          <span class="sr-only">{{ .Site.Title | markdownify }}</span>
          {{ if eq $logo.MediaType.SubType "svg" }}
            <span class="logo object-scale-down object-left nozoom">
              {{ $logo.Content | safeHTML }}
            </span>
          {{ else }}
            <img
              src="{{ $logo.RelPermalink }}"
              width="{{ div $logo.Width 2 }}"
              height="{{ div $logo.Height 2 }}"
              class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom"
              alt="{{ .Site.Title }}">
          {{ end }}
        </a>
      </div>
    {{ end }}
  {{- end }}
{{ end }}

{{/* Desktop navigation */}}
{{ define "HeaderDesktopNavigation" }}
  <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12" aria-label="Main navigation">
    {{ if .Site.Menus.main }}
      {{ range .Site.Menus.main }}
        {{ partial "header/header-option.html" . }}
      {{ end }}
    {{ end }}

    {{ partial "translations.html" . }}
    {{ if .Site.Params.enableA11y | default false }}
      {{ template "HeaderA11y" (dict "prefix" "desktop-" "Site" .Site) }}
    {{ end }}


    {{ if .Site.Params.footer.showAppearanceSwitcher | default false }}
      <div class="flex items-center">
        <button
          id="appearance-switcher"
          aria-label="Dark mode switcher"
          type="button"
          class="text-base hover:text-primary-600 dark:hover:text-primary-400">
          <div class="flex items-center justify-center dark:hidden">
            {{ partial "icon.html" "moon" }}
          </div>
          <div class="items-center justify-center hidden dark:flex">
            {{ partial "icon.html" "sun" }}
          </div>
        </button>
      </div>
    {{ end }}
  </nav>
{{ end }}

{{/* Mobile navigation */}}
{{ define "HeaderMobileNavigation" }}
  <div class="flex md:hidden items-center gap-x-5 h-12">

    {{ partial "translations.html" . }}
    {{ if .Site.Params.enableA11y | default false }}
      {{ template "HeaderA11y" (dict "prefix" "mobile-" "Site" .Site) }}
    {{ end }}


    {{ if .Site.Params.footer.showAppearanceSwitcher | default false }}
      <button
        id="appearance-switcher-mobile"
        aria-label="Dark mode switcher"
        type="button"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1">
        <div class="flex items-center justify-center dark:hidden">
          {{ partial "icon.html" "moon" }}
        </div>
        <div class="items-center justify-center hidden dark:flex">
          {{ partial "icon.html" "sun" }}
        </div>
      </button>
    {{ end }}
  </div>
{{ end }}

{{ define "HeaderMobileMenu" }}
  <div class="-my-2 md:hidden">
    <div id="menu-button" class="block">
      {{ if .Site.Menus.main }}
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          {{ partial "icon.html" "bars" }}
        </div>
        <div
          id="menu-wrapper"
          class="fixed inset-0 z-30 invisible w-screen h-screen m-0 transition-opacity opacity-0 cursor-default"
          style="background-color: rgba(0, 0, 0, 0.3) !important;">
          
          <!-- Sidebar Menu Panel -->
          <div
            id="menu-sidebar"
            class="fixed top-0 left-0 h-full w-1/4 min-w-[280px] max-w-[400px] overflow-y-auto shadow-xl transition-transform duration-300 ease-in-out"
            style="background-color: #FEFAF6 !important; transform: translateX(-100%) !important;">
            
            <ul
              class="flex space-y-2 mt-3 flex-col items-start w-full px-6 py-6 overflow-visible list-none"
              style="background-color: #FEFAF6 !important;">
            <li id="menu-close-button">
              <span
                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
                {{ partial "icon.html" "xmark" }}
              </span>
            </li>

            <!-- Coloring Pages - Direct Link -->
            <li class="w-full mb-2">
              <a href="{{ "/coloring-pages/" | relLangURL }}" class="flex items-center justify-between p-2 mobile-menu-hover rounded-md transition-colors">
                <span class="text-lg font-medium">Coloring Pages</span>
              </a>
            </li>

            <!-- Categories - Collapsible -->
            <li class="w-full mb-2">
              <button 
                id="categories-toggle"
                class="flex items-center justify-between w-full p-2 mobile-menu-hover rounded-md transition-colors"
                aria-expanded="false">
                <span class="text-lg font-medium">Categories</span>
                <svg class="w-5 h-5 transition-transform duration-200 categories-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="categories-content" class="hidden mt-2 pl-4" style="background-color: #FEFAF6 !important;">
                <!-- Categories Mega Menu Content -->
                <div class="mega-menu-mobile-content" style="background-color: #FEFAF6 !important;">
                  
                  <!-- Main 5 categories -->
                  {{ $mainCategories := slice "animals-coloring-pages" "fantasy-coloring-pages" "superheroes-coloring-pages" "cartoons-coloring-pages" "holidays-coloring-pages" }}
                  
                  {{ range $mainCategories }}
                    {{ $section := site.GetPage (printf "/%s" .) }}
                    {{ if $section }}
                      <div class="mega-menu-mobile-category" style="background-color: #FEFAF6 !important;">
                        <h4 class="mega-menu-mobile-category-title">
                          <a href="{{ $section.RelPermalink }}">{{ $section.Title }}</a>
                        </h4>
                        <ul class="mega-menu-mobile-posts">
                          {{ range first 4 $section.Pages }}
                            <li>
                              <a href="{{ .RelPermalink }}" class="mega-menu-mobile-post-link">
                                {{ .Title }}
                              </a>
                            </li>
                          {{ end }}
                        </ul>
                        <a href="{{ $section.RelPermalink }}" class="mega-menu-mobile-all-link">
                          â†’ All Pages
                        </a>
                      </div>
                    {{ end }}
                  {{ end }}
                  
                  <!-- Other Categories Section -->
                  <div class="mega-menu-mobile-category mega-menu-mobile-other" style="background-color: #FEFAF6 !important;">
                    <h4 class="mega-menu-mobile-category-title">Other Categories</h4>
                    <ul class="mega-menu-mobile-posts">
                      {{ $otherCategories := slice "monthly-coloring-pages" "video-games-coloring-pages" "education-coloring-pages" "food-coloring-pages" "vehicles-coloring-pages" "flowers-coloring-pages" "nature-coloring-pages" }}
                      {{ range $otherCategories }}
                        {{ $section := site.GetPage (printf "/%s" .) }}
                        {{ if $section }}
                          <li>
                            <h4 class="mega-menu-mobile-category-title">
                              <a href="{{ $section.RelPermalink }}">{{ $section.Title }}</a>
                            </h4>
                          </li>
                        {{ end }}
                      {{ end }}
                    </ul>
                  </div>
                  
                </div>
              </div>
            </li>

            <!-- About - Collapsible -->
            <li class="w-full mb-2">
              <button 
                id="about-toggle"
                class="flex items-center justify-between w-full p-2 mobile-menu-hover rounded-md transition-colors"
                aria-expanded="false">
                <span class="text-lg font-medium">About</span>
                <svg class="w-5 h-5 transition-transform duration-200 about-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="about-content" class="hidden mt-2 pl-4" style="background-color: #FEFAF6 !important;">
                <a href="{{ "/about-us/" | relLangURL }}" class="block p-2 mobile-menu-hover rounded-md transition-colors">
                  About Us
                </a>
                <a href="{{ "/contact/" | relLangURL }}" class="block p-2 mobile-menu-hover rounded-md transition-colors">
                  Contact
                </a>
              </div>
            </li>

            </ul>
            {{ if .Site.Menus.subnavigation }}
              <hr class="mx-6 border-gray-200">
              <ul
                class="flex mt-4 flex-col items-start w-full px-6 py-6 overflow-visible list-none"
                style="background-color: #FEFAF6 !important;">
                {{ range .Site.Menus.subnavigation }}
                  <li class="mb-1">
                    <a
                      href="{{ .URL }}"
                      {{ if or (strings.HasPrefix .URL "http:" ) (strings.HasPrefix .URL "https:") }}
                        target="_blank"
                      {{ end }}
                      class="flex items-center">
                      {{ if .Pre }}
                        <span {{ if and .Pre .Name }}class="mr-3"{{ end }}>
                          {{ partial "icon.html" .Pre }}
                        </span>
                      {{ end }}
                      <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="{{ .Title }}">
                        {{ .Name | markdownify }}
                      </p>
                    </a>
                  </li>
                {{ end }}
              </ul>
            {{ end }}
          </div>
        </div>
      {{ end }}
    </div>
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuButton = document.querySelector('#menu-button');
    const menuWrapper = document.querySelector('#menu-wrapper');
    const menuCloseButton = document.querySelector('#menu-close-button');

    const menuSidebar = document.querySelector('#menu-sidebar');
    
    // Collapsible menu elements
    const categoriesToggle = document.querySelector('#categories-toggle');
    const categoriesContent = document.querySelector('#categories-content');
    const categoriesChevron = document.querySelector('.categories-chevron');
    
    const aboutToggle = document.querySelector('#about-toggle');
    const aboutContent = document.querySelector('#about-content');
    const aboutChevron = document.querySelector('.about-chevron');
    
    if (menuButton && menuWrapper) {
      menuButton.addEventListener('click', function() {
        menuWrapper.classList.remove('invisible', 'opacity-0');
        menuWrapper.classList.add('visible', 'opacity-100');
        document.body.style.overflow = 'hidden';
        // Slide in the sidebar
        setTimeout(() => {
          if (menuSidebar) {
            menuSidebar.style.setProperty('transform', 'translateX(0)', 'important');
          }
        }, 10);
      });
    }

    if (menuCloseButton && menuWrapper) {
      menuCloseButton.addEventListener('click', function() {
        // Slide out the sidebar first
        if (menuSidebar) {
          menuSidebar.style.setProperty('transform', 'translateX(-100%)', 'important');
        }
        // Hide wrapper after animation
        setTimeout(() => {
          menuWrapper.classList.add('invisible', 'opacity-0');
          menuWrapper.classList.remove('visible', 'opacity-100');
          document.body.style.overflow = '';
        }, 300);
      });
    }

    // Close on backdrop click
    if (menuWrapper) {
      menuWrapper.addEventListener('click', function(e) {
        // Close when clicking on backdrop (not sidebar)
        if (e.target === menuWrapper) {
          if (menuSidebar) {
            menuSidebar.style.setProperty('transform', 'translateX(-100%)', 'important');
          }
          setTimeout(() => {
            menuWrapper.classList.add('invisible', 'opacity-0');
            menuWrapper.classList.remove('visible', 'opacity-100');
            document.body.style.overflow = '';
          }, 300);
        }
      });
    }
    
    // Categories collapse functionality
    if (categoriesToggle && categoriesContent && categoriesChevron) {
      categoriesToggle.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !isExpanded);
        categoriesContent.classList.toggle('hidden');
        categoriesChevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
      });
    }

    // About collapse functionality
    if (aboutToggle && aboutContent && aboutChevron) {
      aboutToggle.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !isExpanded);
        aboutContent.classList.toggle('hidden');
        aboutChevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
      });
    }
  });
  </script>
{{ end }}

{{ define "HeaderA11y" }}
  {{- $prefix := .prefix | default "" -}}
  <div class="flex items-center">
    <button
      id="{{ $prefix }}a11y-toggle"
      aria-label="Open accessibility panel"
      aria-expanded="false"
      type="button"
      class="text-base hover:text-primary-600 dark:hover:text-primary-400"
      role="button"
      aria-pressed="false">
      {{ partial "icon.html" "a11y" }}
    </button>

    <div id="{{ $prefix }}a11y-overlay" class="fixed inset-0 z-500 hidden"></div>

    <div
      id="{{ $prefix }}a11y-panel"
      role="dialog"
      aria-labelledby="{{ $prefix }}a11y-panel-title"
      class="a11y-panel-enter fixed hidden z-500 p-6 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 rounded-lg shadow-xl bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700"
      style="min-width: 20rem;">
      <div class="flex items-center justify-between mb-6">
        <h3
          id="{{ $prefix }}a11y-panel-title"
          class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">
          Accessibility settings
        </h3>
        <button
          id="{{ $prefix }}a11y-close"
          class="text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200"
          aria-label="Close a11y panel">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="space-y-5">
        {{- $toggles := slice
          (dict "id" (print $prefix "disable-blur") "label" (i18n "a11y.disable_blur"))
          (dict "id" (print $prefix "disable-images") "label" (i18n "a11y.disable_images"))
          (dict "id" (print $prefix "underline-links") "label" (i18n "a11y.show_link_underline"))
          (dict "id" (print $prefix "zen-mode") "label" (i18n "article.zen_mode_title.enable"))
        -}}


        {{- range $toggles }}
          <div class="flex items-center justify-between">
            <label for="{{ .id }}" class="text-sm font-medium text-neutral-700 dark:text-neutral-300">
              {{ .label }}
            </label>
            <div class="ios-toggle">
              <input type="checkbox" id="{{ .id }}">
            </div>
          </div>
        {{- end }}


        <div class="flex items-center justify-between">
          <label
            for="{{ $prefix }}font-size-select"
            class="text-sm font-medium text-neutral-700 dark:text-neutral-300">
            {{ i18n "a11y.font_size" }}
          </label>
          <select
            id="{{ $prefix }}font-size-select"
            class="border rounded-lg px-3 py-1.5 pr-8 text-neutral-900 text-sm dark:bg-neutral-700 dark:text-neutral-200 focus:ring-primary-500 focus:border-primary-500">
            {{ $fontSizes := slice "default" "12px" "14px" "16px" "18px" "20px" "22px" "24px" }}
            {{ range $fontSizes }}
              <option value="{{ . }}">{{ . }}</option>
            {{ end }}
          </select>
        </div>
      </div>
    </div>
  </div>
{{ end }}

{{/* ========== Render HTML ========== */}}
<div
  class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0">
  {{ template "HeaderLogo" . }}
  <div class="flex flex-1 items-center justify-between">
    {{ template "HeaderDesktopNavigation" . }}
    {{ template "HeaderMobileNavigation" . }}
  </div>
  {{ template "HeaderMobileMenu" . }}
</div>

{{ if .Site.Menus.subnavigation }}
  <div
    class="main-menu flex pb-3 flex-col items-end justify-between md:justify-start space-x-3 {{ if .Site.Params.Logo }}
      -mt-[15px]
    {{ end }}">
    <div class="hidden md:flex items-center space-x-5">
      {{ range .Site.Menus.subnavigation }}
        <a
          href="{{ .URL }}"
          {{ if or (strings.HasPrefix .URL "http:" ) (strings.HasPrefix .URL "https:" ) }}
            target="_blank"
          {{ end }}
          class="flex items-center">
          {{ if .Pre }}
            <span {{ if and .Pre .Name }}class="mr-1"{{ end }}>
              {{ partial "icon.html" .Pre }}
            </span>
          {{ end }}
          <p class="text-xs font-light text-gray-500 hover:text-gray-900" title="{{ .Title }}">
            {{ .Name | markdownify }}
          </p>
        </a>
      {{ end }}
    </div>
  </div>
{{ end }}

{{ if .Site.Params.highlightCurrentMenuArea }}
  <script>
    (function () {
      var $mainmenu = $(".main-menu");
      var path = window.location.pathname;
      $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
        $(e).children("p").addClass("active");
      });
    })();
  </script>
{{ end }}